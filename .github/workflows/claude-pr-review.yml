name: Claude Code PR Review & Auto Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt --break-system-packages || pip install -r requirements.txt

      - name: Run Tests
        id: run_tests
        run: |
          pip install pytest pytest-asyncio httpx
          pytest tests/ -v --tb=short 2>&1 | tee test_output.txt
          echo "test_exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Claude Code Review
        id: claude_review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the diff
          git diff origin/main..HEAD > pr_diff.txt
          
          # Run Claude Code review
          claude -p "
          You are a senior code reviewer for AgriGPT - a FastAPI backend for agricultural AI platform.
          
          Review the following PR diff and provide:
          1. Summary of changes
          2. Potential bugs or issues
          3. Security concerns
          4. Code quality feedback
          5. Final verdict: APPROVE or REQUEST_CHANGES
          
          Test Results:
          $(cat test_output.txt 2>/dev/null || echo 'No tests found')
          
          PR Diff:
          $(cat pr_diff.txt)
          
          End your response with exactly one line: 'VERDICT: APPROVE' or 'VERDICT: REQUEST_CHANGES'
          " > claude_review.txt 2>&1
          
          cat claude_review.txt
          
          # Extract verdict
          if grep -q "VERDICT: APPROVE" claude_review.txt; then
            echo "verdict=APPROVE" >> $GITHUB_OUTPUT
          else
            echo "verdict=REQUEST_CHANGES" >> $GITHUB_OUTPUT
          fi

      - name: Post Review Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEW_BODY=$(cat claude_review.txt)
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "## ü§ñ Claude Code Review

          $REVIEW_BODY"

      - name: Approve and Merge PR
        if: steps.claude_review.outputs.verdict == 'APPROVE' && steps.run_tests.outputs.test_exit_code == '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr review ${{ github.event.pull_request.number }} --approve --body "‚úÖ Claude Code approved this PR. All tests passed."
          gh pr merge ${{ github.event.pull_request.number }} --squash --auto \
            --subject "$(gh pr view ${{ github.event.pull_request.number }} --json title -q .title)"

      - name: Request Changes
        if: steps.claude_review.outputs.verdict == 'REQUEST_CHANGES'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr review ${{ github.event.pull_request.number }} \
            --request-changes \
            --body "‚ùå Claude Code requested changes. Please review the comments above."
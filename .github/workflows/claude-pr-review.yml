name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - run: pip install anthropic

      - run: git diff origin/main..HEAD > pr_diff.txt

      - name: Claude Reviews
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          python3 << 'PYEOF'
          import anthropic, os

          diff = open("pr_diff.txt").read()[:3000] or "Empty diff"
          author = os.environ["PR_AUTHOR"]

          client = anthropic.Anthropic()
          response = client.messages.create(
              model="claude-opus-4-6",
              max_tokens=800,
              messages=[{
                  "role": "user",
                  "content": f"""Senior engineer reviewing AgriGPT (FastAPI WhatsApp bot for Indian farmers).

          PR by: {author}
          Diff: {diff}

          Write a short human review:
          - Start with "Hey {author}!"
          - What's good âœ…
          - What needs fixing ðŸ” (explain farmer impact if relevant)
          - 1 line overall summary

          End with VERDICT: APPROVE or VERDICT: REQUEST_CHANGES"""
              }]
          )

          review = response.content[0].text
          open("review.txt", "w").write(review)
          verdict = "APPROVE" if "VERDICT: APPROVE" in review else "REQUEST_CHANGES"
          open(os.environ["GITHUB_OUTPUT"], "a").write(f"verdict={verdict}\n")
          PYEOF

      - name: Post Review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Tag added so Workflow 2 can find this comment later
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "<!-- claude-review -->
          $(cat review.txt)

          ---
          ðŸ’¬ *Comment here if you have questions.*"

      - name: Approve
        if: steps.review.outputs.verdict == 'APPROVE'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr review ${{ github.event.pull_request.number }} --approve \
            --body "Looks good! âœ… Ready for human merge."

      - name: Request Changes
        if: steps.review.outputs.verdict == 'REQUEST_CHANGES'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr review ${{ github.event.pull_request.number }} --request-changes \
            --body "Few things to fix â€” see comments above ðŸ‘†"
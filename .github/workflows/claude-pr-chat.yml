name: Claude PR Chat

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  issues: write

jobs:
  claude-respond:
    # Ignore bot comments to prevent infinite loop
    if: github.event.issue.pull_request != null && github.event.comment.user.type != 'Bot'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - run: pip install anthropic requests

      - name: Claude Responds
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT: ${{ github.event.comment.body }}
          COMMENTER: ${{ github.event.comment.user.login }}
          PR_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          python3 << 'PYEOF'
          import anthropic, os, requests

          comment = os.environ["COMMENT"]
          commenter = os.environ["COMMENTER"]
          pr_number = os.environ["PR_NUMBER"]
          repo = os.environ["REPO"]
          token = os.environ["GH_TOKEN"]
          headers = {"Authorization": f"token {token}", "Accept": "application/vnd.github.v3+json"}

          # Fetch Claude's previous review (tagged comment)
          comments = requests.get(
              f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments",
              headers=headers
          ).json()

          prev_review = ""
          for c in comments:
              if "<!-- claude-review -->" in c.get("body", ""):
                  # Strip the tag, keep first 1000 chars
                  prev_review = c["body"].replace("<!-- claude-review -->", "").strip()[:1000]
                  break

          # Fetch diff (trimmed)
          diff_headers = {**headers, "Accept": "application/vnd.github.v3.diff"}
          diff = requests.get(
              f"https://api.github.com/repos/{repo}/pulls/{pr_number}",
              headers=diff_headers
          ).text[:2000]

          client = anthropic.Anthropic()
          response = client.messages.create(
              model="claude-haiku-4-5-20251001",  # fast + cheap for chat
              max_tokens=400,
              messages=[{
                  "role": "user",
                  "content": f"""You're a senior engineer on AgriGPT. Reply to {commenter}'s comment.

          Your previous review:
          {prev_review or 'No previous review found'}

          Diff context:
          {diff}

          Their question/comment:
          {comment}

          Reply conversationally in 3-5 sentences max. Be specific and helpful."""
              }]
          )

          reply = response.content[0].text
          requests.post(
              f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments",
              headers=headers,
              json={"body": f"ðŸ¤– {reply}"}
          )
          PYEOF